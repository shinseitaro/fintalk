
# テクニカル分析

このポストは， [PyLadies Advent Calendar 2018 - Adventar](https://adventar.org/calendars/3116)の2018/12/21に向けて作ったものです．

同資料を使って， [【女性限定】月刊フィントーク ホリデー 株式分析ハンズオン](https://fintalk.connpass.com/event/113679/)も

月一でやっていきます．興味がある方はぜひ遊びに来てください(^^)


## もくじ
1. テクニカル分析とは
1. テクニカル分析をする上で最低限知っておかなくてはいけない DataFrame の使い方

    1. データインポート　datetime, columns 処理も
    1. データアレンジ　欠損値など
    1. 関数とテクニック shift, pct_change(), bool値
    1. 描画
    1. 練習問題

1. テクニカル分析
    1. トレンド系
        1. 移動平均
        1. ボリンジャーバンド
        1. HLバンド
    1. オシレーター系
        1. RSI
        1. MACD
        1. モメンタム        
    1. 練習問題



## テクニカルとは

テクニカル分析というのは、

データから指標を作り、その指標と現在の値との関係を元に、将来を予測するもの
（と私は考えています）

指標とは、[Wikipedia](https://ja.wikipedia.org/wiki/%E6%8C%87%E6%A8%99)先生によると、**物事を判断したり評価したりするための目じるしとなるもの**です。（なるほど！)


## テクニカル分析をする上で最低限知っておかなくてはいけない DataFrame の使い方

テクニカル分析をする前に、知っておいてほうがよい pandas DataFrame の基本的な使い方を紹介します。これがすべてというわけではありませんが、ここでは必須知識ですので、覚えてください。

### データインポート

ここでは csv のデータのインポートと、その後の処理を行います。

まずは、[日経平均プロフィル-日経の指数公式サイト-　ダウンロードセンター](https://indexes.nikkei.co.jp/nkave/index?type=download)から，`日経平均株価＞日次データ`をダウロードしてください。そのファイルをDataFrame化します。




```python

import pandas as pd 

# 適宜変更
fpath = '/tmp/nikkei_stock_average_daily_jp.csv'

df = pd.read_csv(fpath, 
                 encoding="shift-jis", # ここを外すとエンコードエラーが出る
                 index_col="データ日付", # index コラムを指定
                 )
# 最終行にいらないコメントが入っているのでそれを除去
df = df.iloc[:-1] 
# DataFrame を確認するために、tail()で最終行を確認。.head() でもOK
df.tail()


```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>終値</th>
      <th>始値</th>
      <th>高値</th>
      <th>安値</th>
    </tr>
    <tr>
      <th>データ日付</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2018/11/29</th>
      <td>22262.60</td>
      <td>22360.98</td>
      <td>22437.95</td>
      <td>22241.17</td>
    </tr>
    <tr>
      <th>2018/11/30</th>
      <td>22351.06</td>
      <td>22274.97</td>
      <td>22362.20</td>
      <td>22231.96</td>
    </tr>
    <tr>
      <th>2018/12/03</th>
      <td>22574.76</td>
      <td>22629.39</td>
      <td>22698.79</td>
      <td>22550.29</td>
    </tr>
    <tr>
      <th>2018/12/04</th>
      <td>22036.05</td>
      <td>22533.97</td>
      <td>22576.62</td>
      <td>22033.41</td>
    </tr>
    <tr>
      <th>2018/12/05</th>
      <td>21919.33</td>
      <td>21755.17</td>
      <td>21979.18</td>
      <td>21708.82</td>
    </tr>
  </tbody>
</table>
</div>



#### ポイント＆解説

+ 慣習として DataFrame の変数は `df` とされる場合がおおい。
+ `encoding=` をはずとと`UnicodeDecodeError: 'utf-8' codec can't decode byte 0x83 in position 0: invalid start byte` 
+ ダウンロードしたファイルの最終行に、`本資料は日経の著作物であり、本資料の全部又は一部を・・・・`というコメントが入っているのでそれをスライスで削除


### データアレンジ

データの型を確認しましょう。パッと見て、数字や日次の様にみえて、実はただの文字列オブジェクトだったということはよく有ります。



```python
# まずはデータ日付index. 
# dtype=が Datetimeindex でなくては行けません。
df.index
```




    Index(['2015/01/05', '2015/01/06', '2015/01/07', '2015/01/08', '2015/01/09',
           '2015/01/13', '2015/01/14', '2015/01/15', '2015/01/16', '2015/01/19',
           ...
           '2018/11/21', '2018/11/22', '2018/11/26', '2018/11/27', '2018/11/28',
           '2018/11/29', '2018/11/30', '2018/12/03', '2018/12/04', '2018/12/05'],
          dtype='object', name='データ日付', length=965)




```python
df.index = pd.to_datetime(df.index)
df.index
```




    DatetimeIndex(['2015-01-05', '2015-01-06', '2015-01-07', '2015-01-08',
                   '2015-01-09', '2015-01-13', '2015-01-14', '2015-01-15',
                   '2015-01-16', '2015-01-19',
                   ...
                   '2018-11-21', '2018-11-22', '2018-11-26', '2018-11-27',
                   '2018-11-28', '2018-11-29', '2018-11-30', '2018-12-03',
                   '2018-12-04', '2018-12-05'],
                  dtype='datetime64[ns]', name='データ日付', length=965, freq=None)




```python
# 次は価格。dtypeが数値型であればOK. 他のコラムも念の為確認しておきましょう。
df["終値"].head()

```




    データ日付
    2015-01-05    17408.71
    2015-01-06    16883.19
    2015-01-07    16885.33
    2015-01-08    17167.10
    2015-01-09    17197.73
    Name: 終値, dtype: float64



コラム名を日本語から英語に変えたい人もいるかもしれません（私も英語派です）。その時はこのように辞書型を渡せばよいです。


```python
df = df.rename(columns={"終値":"close", "始値":"open", "高値":"high", "安値":"low"})
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>データ日付</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 一旦index化したコラム名は、このように変更します。
df.index.name = "datetime"
df.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
    </tr>
  </tbody>
</table>
</div>



### 関数とテクニック

DataFrameを使って分析する時にどうしても覚えなくてはいけない関数とテクニックを書きます。

#### shift 

データを上げさげする。



```python
df.shift(1).head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_test = df.copy()
df_test["yesterday's close"] = df["close"].shift(1)
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>yesterday's close</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>17408.71</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>16883.19</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>16885.33</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>17167.10</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_test = df.copy()
df_test["tomorrow's open"] = df["open"].shift(-1)
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>tomorrow's open</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>17101.58</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>16808.26</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>17067.40</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>17318.74</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>16970.88</td>
    </tr>
  </tbody>
</table>
</div>



#### pct_change() 

n行前のデータからの変化率を出す。




```python
df.pct_change().head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>-0.030187</td>
      <td>-0.012935</td>
      <td>-0.024489</td>
      <td>-0.019600</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>0.000127</td>
      <td>-0.017152</td>
      <td>-0.007992</td>
      <td>-0.004352</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>0.016687</td>
      <td>0.015417</td>
      <td>0.015853</td>
      <td>0.012365</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>0.001784</td>
      <td>0.014726</td>
      <td>0.005738</td>
      <td>0.006667</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_test = df.copy()
df_test["day return"] = df["close"].pct_change() # day return = 日次収益率
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>day return</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>-0.030187</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>0.000127</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>0.016687</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>0.001784</td>
    </tr>
  </tbody>
</table>
</div>




```python
# shift を使って同じ計算ができるが、混乱しやすいので pct_change()がおすすめ。

(df / df.shift(1) - 1).head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>-0.030187</td>
      <td>-0.012935</td>
      <td>-0.024489</td>
      <td>-0.019600</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>0.000127</td>
      <td>-0.017152</td>
      <td>-0.007992</td>
      <td>-0.004352</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>0.016687</td>
      <td>0.015417</td>
      <td>0.015853</td>
      <td>0.012365</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>0.001784</td>
      <td>0.014726</td>
      <td>0.005738</td>
      <td>0.006667</td>
    </tr>
  </tbody>
</table>
</div>



#### ポイント：次の日の日次収益率を同じ行に入れて置きたい場合

注意：コラムに名前をつけるとき将来の数値だわかるようにしておくことが大切。



```python
df_test = df.copy()
df_test["day return"] = df["close"].pct_change() # day return = 日次収益率
df_test["day return"] = df_test["day return"].shift(-1)
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>day return</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>-0.030187</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>0.000127</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>0.016687</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>0.001784</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>-0.006397</td>
    </tr>
  </tbody>
</table>
</div>



#### bool 値を使う

bool値を使うと simulation をする時に便利です。

例えば、始値から終値が上昇した場合、その日の大引けで買って、次の日の寄りで売るというsimulationを書いてみます。

（一口メモ：大引けから寄りの間だけポジションを持つ事を、「オーバーナイトでポジションを持つ」といいます。）



```python
df_test = df.copy()
df_test["intraday return"] = df_test["close"] / df_test["open"] - 1 # intraday return = 日中収益率
df_test["is intraday return positive"] = df_test["intraday return"] > 0 
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>intraday return</th>
      <th>is intraday return positive</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>0.004792</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>-0.012770</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>0.004585</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>0.005842</td>
      <td>True</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>-0.006987</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div>




```python
# オーバーナイトの収益を計算
df_test["overnight return"] = df_test["open"].shift(-1) / df["close"] - 1
df_test.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>intraday return</th>
      <th>is intraday return positive</th>
      <th>overnight return</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>0.004792</td>
      <td>True</td>
      <td>-0.017642</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>-0.012770</td>
      <td>False</td>
      <td>-0.004438</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>0.004585</td>
      <td>True</td>
      <td>0.010783</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>0.005842</td>
      <td>True</td>
      <td>0.008833</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>-0.006987</td>
      <td>False</td>
      <td>-0.013191</td>
    </tr>
  </tbody>
</table>
</div>



`2015-01-05`で、日中収益率は0.47％で正です。そこで終値で株を買うことにします。

`overnight return` には終値から次の日の始値の変化率（＝オーバーナイトの収益率）が入っています。気をつけなくてはいけないのは、ここに入っている数値は将来の数字だと言うことです。

例えば `2015-01-05` 時点で、`overnight return` である `-0.017642` は明日にならないとわからない数値です。

ここで、`is intraday return positive` は正負、つまり、1もしくは0のどちらかですので、

`is intraday return positive * overnight return`  を計算することで、`is intraday return positive`が正の時だけの数値を得ることが出来ます。



```python
df_test["results"] = df_test["is intraday return positive"] * df_test["overnight return"]
df_test.head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>intraday return</th>
      <th>is intraday return positive</th>
      <th>overnight return</th>
      <th>results</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>0.004792</td>
      <td>True</td>
      <td>-0.017642</td>
      <td>-0.017642</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>-0.012770</td>
      <td>False</td>
      <td>-0.004438</td>
      <td>-0.000000</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>0.004585</td>
      <td>True</td>
      <td>0.010783</td>
      <td>0.010783</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>0.005842</td>
      <td>True</td>
      <td>0.008833</td>
      <td>0.008833</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>-0.006987</td>
      <td>False</td>
      <td>-0.013191</td>
      <td>-0.000000</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17087.71</td>
      <td>16970.88</td>
      <td>17087.71</td>
      <td>16828.27</td>
      <td>0.006884</td>
      <td>True</td>
      <td>-0.007367</td>
      <td>-0.007367</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>16795.96</td>
      <td>16961.82</td>
      <td>17036.72</td>
      <td>16770.56</td>
      <td>-0.009778</td>
      <td>False</td>
      <td>0.004584</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17108.70</td>
      <td>16872.95</td>
      <td>17141.98</td>
      <td>16856.22</td>
      <td>0.013972</td>
      <td>True</td>
      <td>-0.017286</td>
      <td>-0.017286</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>16864.16</td>
      <td>16812.96</td>
      <td>16864.34</td>
      <td>16592.57</td>
      <td>0.003045</td>
      <td>True</td>
      <td>0.008101</td>
      <td>0.008101</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>17014.29</td>
      <td>17000.78</td>
      <td>17039.80</td>
      <td>16911.58</td>
      <td>0.000795</td>
      <td>True</td>
      <td>0.003371</td>
      <td>0.003371</td>
    </tr>
  </tbody>
</table>
</div>



### 描画

結果は視覚的に見たほうが楽しいですよね。

上記で行った結果を描画してみましょう。




```python
# resultsをプロット
import matplotlib.pyplot as plt 
import matplotlib

# ちょっとおしゃれスタイル
# その他スタイルはこちら
# matplotlibのstyleを変える - Qiita https://qiita.com/eriksoon/items/b93030ba4dc686ecfbba
plt.style.use('ggplot')

%matplotlib inline

fig = plt.figure()
ax = fig.add_subplot(111)
ax.plot(df_test["results"])
plt.show()

```


![png](output_27_0.png)



```python
# 毎日の結果を足し合わせていってプロット
fig = plt.figure()
ax = fig.add_subplot(111)
ax.plot(df_test["results"].cumsum())
plt.show()

```


![png](output_28_0.png)



```python
fig = plt.figure()
ax = fig.add_subplot(111)

ax.plot(df_test["results"].cumsum(), )

# タイトル、軸ラベル設定
ax.set_title("results")
ax.set_xlabel("dates")
ax.set_ylabel("returns")

# 凡例を表示する
ax.legend()

# xラベルを45度回転
plt.setp(ax.get_xticklabels(), rotation=45)

plt.show()


```


![png](output_29_0.png)


#### 日本語を使う

1. 
[pip install して import するだけで matplotlib を日本語表示対応させる - Qiita ](https://qiita.com/uehara1414/items/6286590d2e1ffbf68f6c) に従って

`!pip install japanize-matplotlib` して、

```python
import japanize_matplotlib  # <- これ

plt.plot([1, 2, 3, 4])
plt.xlabel('簡単なグラフ')
plt.show()
```

で問題ないなら、それでOKだと思いますが、私の環境では `TypeError: scandir: illegal type for path parameter` がでましたので、ご指南書に従って日本語化しました。

2. 

https://github.com/adobe-fonts/source-han-code-jp/archive/2.000R.zip  をダウンロードしてインストール


```
import os
from matplotlib import font_manager 

font_manager._rebuild()

if os.name == 'nt':
    font_dir = font_manager.win32FontDirectory()
else:
    # 各自設定
    font_dir = '/usr/share/fonts/source-han-code-jp-2.000R/OTF'
font_path = os.path.join(font_dir, 'SourceHanCodeJP-Regular.otf')
font = font_manager.FontProperties(fname=font_path, size=14)

plt.plot([1, 2, 3, 4])
plt.xlabel("簡単なグラフ", fontproperties=font)
plt.show()
``` 



### 練習問題1

1. [https://finance.yahoo.com/quote/SPY/history?p=SPY](https://finance.yahoo.com/quote/SPY/history?p=SPY) からデータダウンロードする。
2. ファイルをDataFrame化する。
3. オーバーナイトの収益をプロットする
4. 日中のHighとLowの差が2％以上だったら、Closeで買って、次の日のCloseで売る。その収益をプロットする。

---


## テクニカル分析

世の中にはたくさんのテクニカル分析が有ります。投資家に人気がある分析指標を使って simulation をしてみましょう。


1. トレンド系
    1. 移動平均
    1. ボリンジャーバンド
    1. HLバンド
1. オシレーター系
    1. RSI
    1. MACD
    1. モメンタム
        


### 移動平均

移動平均とは、時系列データにおいて、ある一定区間ごとの平均値を区間をずらしながら求めたものです。毎日のデータを見るよりも、株価の方向（流れ、大局、）をより見やすくする指標と言えます。

DataFrameのメソッドである `rolling` を使うと簡単に求められます。

+ [pandas.DataFrame.rolling](https://pandas.pydata.org/pandas-docs/stable/generated/pandas.DataFrame.rolling.html)
+ rolling(window, min_periods=None, center=False, win_type=None, on=None, axis=0, closed=None)
+ `window`: 行数を指定。これが区間になる。
+ 返り値は `rolling` オブジェクト。


```python
df_test = df.copy()

# 5日移動平均
n = 5
df_test.rolling(n)
```




    Rolling [window=5,center=False,axis=0]




```python
# この rolling オブジェクトが持つメソッドを使って、ほしい計算結果を得る。
df_test.rolling(n).mean().head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17108.412</td>
      <td>17124.332</td>
      <td>17242.650</td>
      <td>17010.966</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17044.212</td>
      <td>17053.372</td>
      <td>17152.008</td>
      <td>16932.776</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>17026.766</td>
      <td>17025.420</td>
      <td>17137.080</td>
      <td>16910.542</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17071.440</td>
      <td>17038.358</td>
      <td>17170.554</td>
      <td>16920.134</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>17010.852</td>
      <td>16987.470</td>
      <td>17094.680</td>
      <td>16835.430</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>16974.164</td>
      <td>16923.878</td>
      <td>17034.110</td>
      <td>16791.840</td>
    </tr>
  </tbody>
</table>
</div>



プロットして観察します。

株価と移動平均を重ねてプロットすると、なにか気がつくかもしれません。

すこし複雑な図を描く時は `matplotlib.pyplot` を使うと便利です。詳しくは、[PythonユーザのためのJupyter[実践]入門](https://www.amazon.co.jp/dp/4774192236)を買って勉強してください。


```python
import matplotlib.pyplot as plt 

fig = plt.figure(figsize=(20,10))
ax1 = fig.add_subplot(111)

ax1.plot(df_test["close"])
ax1.plot(df_test["close"].rolling(window=20).mean(), c='b')

```




    [<matplotlib.lines.Line2D at 0x7f5b15c5f240>]




![png](output_37_1.png)


さて、この描画から、どんなことが言えそうでしょうか？観察して考えてみましょう。

1. 過去n日と比べて今日の終値が大きく外れていれば、「平均の方にもどるんじゃない？」と予想して逆張り
1. 終値が移動平均より上にある間は買い持ちして、下にある間は売り持ちする。（順張り）

などが考えられます。1をやってみましょう。

まずは、移動平均と終値がどのくらい違いがあるのか見てみましょう。



```python
df_test = df.copy()

n = 20

# ma : Moving Average の略。移動平均を表す時によく使われる。
df_test["ma"] = df_test["close"].rolling(window=n).mean() 
# close と ma しか使わないのでそれだけのDataFrameにする。
df_test = df_test[["close", "ma"]]

df_test["diff"] = df_test["close"] / df_test["ma"] - 1
df_test.head(30)

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>ma</th>
      <th>diff</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17087.71</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>16795.96</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17108.70</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>16864.16</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>17014.29</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-20</th>
      <td>17366.30</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-21</th>
      <td>17280.48</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-22</th>
      <td>17329.02</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-23</th>
      <td>17511.75</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-26</th>
      <td>17468.52</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-27</th>
      <td>17768.30</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-28</th>
      <td>17795.73</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-29</th>
      <td>17606.22</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-30</th>
      <td>17674.39</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-02</th>
      <td>17558.04</td>
      <td>17288.5815</td>
      <td>0.015586</td>
    </tr>
    <tr>
      <th>2015-02-03</th>
      <td>17335.85</td>
      <td>17284.9385</td>
      <td>0.002945</td>
    </tr>
    <tr>
      <th>2015-02-04</th>
      <td>17678.74</td>
      <td>17324.7160</td>
      <td>0.020435</td>
    </tr>
    <tr>
      <th>2015-02-05</th>
      <td>17504.62</td>
      <td>17355.6805</td>
      <td>0.008582</td>
    </tr>
    <tr>
      <th>2015-02-06</th>
      <td>17648.50</td>
      <td>17379.7505</td>
      <td>0.015463</td>
    </tr>
    <tr>
      <th>2015-02-09</th>
      <td>17711.93</td>
      <td>17405.4605</td>
      <td>0.017608</td>
    </tr>
    <tr>
      <th>2015-02-10</th>
      <td>17652.68</td>
      <td>17433.7090</td>
      <td>0.012560</td>
    </tr>
    <tr>
      <th>2015-02-12</th>
      <td>17979.72</td>
      <td>17492.8970</td>
      <td>0.027830</td>
    </tr>
    <tr>
      <th>2015-02-13</th>
      <td>17913.36</td>
      <td>17533.1300</td>
      <td>0.021686</td>
    </tr>
    <tr>
      <th>2015-02-16</th>
      <td>18004.77</td>
      <td>17590.1605</td>
      <td>0.023571</td>
    </tr>
    <tr>
      <th>2015-02-17</th>
      <td>17987.09</td>
      <td>17638.8005</td>
      <td>0.019746</td>
    </tr>
  </tbody>
</table>
</div>



DataFrameのデータを簡単な統計値で確認したい時 `describe()` が便利です。

columns 毎に、個数、平均値、偏差、最大値、最小値、パーセンタイルを出してくれます。


```python
df_test.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>ma</th>
      <th>diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>965.000000</td>
      <td>946.000000</td>
      <td>946.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>19643.427399</td>
      <td>19644.754560</td>
      <td>0.002522</td>
    </tr>
    <tr>
      <th>std</th>
      <td>2212.332882</td>
      <td>2170.108551</td>
      <td>0.027461</td>
    </tr>
    <tr>
      <th>min</th>
      <td>14952.020000</td>
      <td>15628.831000</td>
      <td>-0.120078</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>17768.300000</td>
      <td>17933.825500</td>
      <td>-0.011000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>19620.910000</td>
      <td>19605.356500</td>
      <td>0.005244</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>21676.510000</td>
      <td>21699.081250</td>
      <td>0.020858</td>
    </tr>
    <tr>
      <th>max</th>
      <td>24270.620000</td>
      <td>23700.905000</td>
      <td>0.065013</td>
    </tr>
  </tbody>
</table>
</div>



ここから察するに、`25%` タイルで `-1.1%` ずれているということなので、

close価格が maより-1.1％以下にある場合、ロングポジションを持つことにしてみましょう。




```python
df_test["diff < -0.011"] = df_test["diff"] < -0.011
df_test["day return"] = df_test["close"].pct_change().shift(-1)
df_test["long position result"] = df_test["diff < -0.011"] * df_test["day return"]

fig = plt.figure(figsize=(20,10))
ax1 = fig.add_subplot(111)
ax1.plot(df_test["long position result"].cumsum())

```




    [<matplotlib.lines.Line2D at 0x7f5b15c6c0f0>]




![png](output_43_1.png)


一時怖い時期はありますが、悪くないですね。

**練習問題**

では、`75%`タイルで `2.08％` ずれているので、

close価格が maより2.08％以上にある場合、ショートポジションを持つことにしてみましょう。

ショートポジション（売り持ち）なので、`df_test["day return"]` の計算をどのようにすればよいか注意してください

### ボリンジャーバンド

ボリンジャーバンドも、個人投資家に大変人気のある指標です。ボリバンとも呼ばれています。ボリンジャーとか、ボリバンとか呼ばれています。

移動平均だけでなく、その期間にどのくらい値がバラついたかも算出してバンドを形成し指標化したものです。

この図でいえば、<font color=red>BB_中心線（21）</font>というのが21日移動平均線、<font color=blue>BB_1σ</font>という線が、過去21日の値動きのバラツキの1σ区間です。

![](https://www.jibunbank.co.jp/products/foreign_deposit/chart/help/bollinger_band/img/img_01.png)
[ボリンジャーバンド | チャートの見方 | 為替レート＆チャート | じぶん銀行](https://www.jibunbank.co.jp/products/foreign_deposit/chart/help/bollinger_band/)より

そんな事言われてもわからんと思いますので、実際算出してみましょう。

ボリバンを出すのに便利なライブラリ `talib` を使います。

[mrjbq7/ta-lib: Python wrapper for TA-Lib (http://ta-lib.org/).](https://github.com/mrjbq7/ta-lib)


**メモ：**

talib を使うと、`TypeError: Argument 'real' has incorrect type (expected numpy.ndarray, got Series)` といったerrorに遭遇します。
最初の引数は real 型の配列でなくては行けません。pandas の Series は渡せません。




```python
import talib as ta
import numpy as np

df_test = df.copy()

# BBAND は、価格配列、期間、バンド幅を渡す。
# 返り値は、上端、中央値、下端の価格配列を返します。

upper,middle,lower=ta.BBANDS(df_test["close"].values, 
                             timeperiod=21,
                             nbdevup=2, 
                             nbdevdn=2)

df_bb = pd.DataFrame({"upper":upper, "middle":middle, "lower":lower, "close":df_test["close"].values.astype(np.double)}, index = df_test.index)

df_bb.head(30)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>lower</th>
      <th>middle</th>
      <th>upper</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17087.71</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>16795.96</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17108.70</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>16864.16</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>17014.29</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-20</th>
      <td>17366.30</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-21</th>
      <td>17280.48</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-22</th>
      <td>17329.02</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-23</th>
      <td>17511.75</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-26</th>
      <td>17468.52</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-27</th>
      <td>17768.30</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-28</th>
      <td>17795.73</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-29</th>
      <td>17606.22</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-30</th>
      <td>17674.39</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-02</th>
      <td>17558.04</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-03</th>
      <td>17335.85</td>
      <td>16699.324299</td>
      <td>17290.832381</td>
      <td>17882.340463</td>
    </tr>
    <tr>
      <th>2015-02-04</th>
      <td>17678.74</td>
      <td>16691.126554</td>
      <td>17303.690952</td>
      <td>17916.255351</td>
    </tr>
    <tr>
      <th>2015-02-05</th>
      <td>17504.62</td>
      <td>16745.284375</td>
      <td>17333.282857</td>
      <td>17921.281340</td>
    </tr>
    <tr>
      <th>2015-02-06</th>
      <td>17648.50</td>
      <td>16802.910782</td>
      <td>17369.624286</td>
      <td>17936.337790</td>
    </tr>
    <tr>
      <th>2015-02-09</th>
      <td>17711.93</td>
      <td>16818.526208</td>
      <td>17395.568571</td>
      <td>17972.610935</td>
    </tr>
    <tr>
      <th>2015-02-10</th>
      <td>17652.68</td>
      <td>16837.373443</td>
      <td>17417.232857</td>
      <td>17997.092272</td>
    </tr>
    <tr>
      <th>2015-02-12</th>
      <td>17979.72</td>
      <td>16852.583460</td>
      <td>17459.709524</td>
      <td>18066.835587</td>
    </tr>
    <tr>
      <th>2015-02-13</th>
      <td>17913.36</td>
      <td>16953.848424</td>
      <td>17512.919048</td>
      <td>18071.989671</td>
    </tr>
    <tr>
      <th>2015-02-16</th>
      <td>18004.77</td>
      <td>16989.696779</td>
      <td>17555.589048</td>
      <td>18121.481316</td>
    </tr>
    <tr>
      <th>2015-02-17</th>
      <td>17987.09</td>
      <td>17105.871799</td>
      <td>17609.061905</td>
      <td>18112.252010</td>
    </tr>
  </tbody>
</table>
</div>




```python
fig = plt.figure(figsize=(20,10))
ax = fig.add_subplot(111)

ax.plot(upper,label="upper")
ax.plot(middle,label="middle")
ax.plot(lower,label="lower")
ax.plot(df_bb["close"].values.astype(np.double), label="close")

# 凡例を表示する
ax.legend()

```




    <matplotlib.legend.Legend at 0x7f5b159a39b0>




![png](output_47_1.png)


では観察しましょう。

両端（`upper`と`lower`)に `close` がタッチしたら反転しているようにも見えますね。

たとえば、`close` と `lower` を超えたら、その後急に上がり戻っているように見える箇所があります。

なので、`close` と `lower` の関係と、`close` の値動きの関係を散布図で観察してみましょう。



```python
# lower と close の比率を確認（-1は0を基点にしたいので）
df_bb["close / lower"] = df_bb["close"] / df_bb["lower"] - 1 

# 一日後の収益率と二日後の収益率を取得
df_bb["1day return"] = df_bb["close"].pct_change(1).shift(-1)
df_bb["2day return"] = df_bb["close"].pct_change(2).shift(-2)
df_bb["3day return"] = df_bb["close"].pct_change(3).shift(-3)

df_bb.head()


```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>lower</th>
      <th>middle</th>
      <th>upper</th>
      <th>close / lower</th>
      <th>1day return</th>
      <th>2day return</th>
      <th>3day return</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.030187</td>
      <td>-0.030064</td>
      <td>-0.013879</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.000127</td>
      <td>0.016816</td>
      <td>0.018630</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.016687</td>
      <td>0.018501</td>
      <td>0.011986</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>0.001784</td>
      <td>-0.004625</td>
      <td>-0.021619</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>-0.006397</td>
      <td>-0.023362</td>
      <td>-0.005177</td>
    </tr>
  </tbody>
</table>
</div>




```python
fig = plt.figure(figsize=(20,10))
ax = fig.add_subplot(111)

#ax.scatter(x=df_bb["close / lower"], y=df_bb["1day return"], alpha=0.5)
ax.scatter(x=df_bb["close / lower"], y=df_bb["2day return"], alpha=0.5, c='blue')
#ax.scatter(x=df_bb["close / lower"], y=df_bb["3day return"], alpha=0.5, c='green')

ax.legend()
```




    <matplotlib.legend.Legend at 0x7f5b1596ad68>




![png](output_50_1.png)


そうすると、
+ `close/lower - 1` が -0.025以下、（closeがlowerよりも2.5％下にある）→2日後ポジティブリターンになっている場合が多い
+ `close/lower - 1` が 0.10以上、（closeがlowerよりも10％以上上にある）→2日後はネガティブリターンになっている場合が多い



```python
results = (df_bb["close / lower"] < -0.025) * df_bb["2day return"] + \
          (df_bb["close / lower"] > 0.10) * df_bb["2day return"] * - 1
results.sum()
```




    0.35499126085079646




```python
fig = plt.figure(figsize=(20,10))
ax = fig.add_subplot(111)
ax.plot(results.cumsum())
```




    [<matplotlib.lines.Line2D at 0x7f5b15979550>]




![png](output_53_1.png)


**練習問題**

1. `upper` と`close`の関係を見るとどうでしょうか？
1. バンド幅を1に変えて観察するとどうでしょうか？
1. 期間を21日ではなく、他の日付にしたらどうでしょうか？




### モメンタム

モメンタムとは、ｎ日前の価格との変化率を見る指標です。

使い方によって、オシレータ系にもトレンド系にもなる指標です。

今回はオシレータ系の使い方をしたいと思います。参考にしたサイトはこちら。

[モメンタムの見方・使い方| 株の達人](https://www.sevendata.co.jp/shihyou/technical/momentum.html#01)

このサイトによると、モメンタムの使い方は、
**相場が上昇している時の勢いが弱くなってきているのか、また相場が下降している時の勢いが強くなってきているのかを捉える先行指標**という事で、これまでのように売買のタイミングシグナル見つけるというよりは、現在は上げ相場なのか、下げ相場なのかを見るという事に使えそうです。

よって、その雰囲気を数値で表現して行きたいと思います。

まずは描画して雰囲気を掴みましょう。


                                             
                                                        


```python
df_test = df.copy()

# n日前と現在の価格を比べる
n = 5 
df_test["past close"] = df_test["close"].shift(n) 
df_test["mom"] = df_test["close"] / df_test["past close"] - 1 
# pct_change()でも同じ
#df_test["mom"] = df_test["close"].pct_change(n)

df_test.head(10)

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>past close</th>
      <th>mom</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17087.71</td>
      <td>16970.88</td>
      <td>17087.71</td>
      <td>16828.27</td>
      <td>17408.71</td>
      <td>-0.018439</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>16795.96</td>
      <td>16961.82</td>
      <td>17036.72</td>
      <td>16770.56</td>
      <td>16883.19</td>
      <td>-0.005167</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17108.70</td>
      <td>16872.95</td>
      <td>17141.98</td>
      <td>16856.22</td>
      <td>16885.33</td>
      <td>0.013229</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>16864.16</td>
      <td>16812.96</td>
      <td>16864.34</td>
      <td>16592.57</td>
      <td>17167.10</td>
      <td>-0.017647</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>17014.29</td>
      <td>17000.78</td>
      <td>17039.80</td>
      <td>16911.58</td>
      <td>17197.73</td>
      <td>-0.010667</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_test = df.copy()

n = 25 
df_test["past close"] = df_test["close"].shift(n) 
df_test["mom"] = df_test["close"] / df_test["past close"] - 1 

fig = plt.figure(figsize=(20,10))
# add_subplot(総行数,総列数,番号)
ax1 = fig.add_subplot(211)
ax2 = fig.add_subplot(212)

ax1.plot(df_test["close"])
ax2.plot(df_test["mom"], c = 'blue')
ax2.axhline(0, color='black', lw=2)

```




    <matplotlib.lines.Line2D at 0x7f5b15913898>




![png](output_57_1.png)



```python
# ｘ軸がずれていて確認しづらい。subplots 関数を使う
fig, axes = plt.subplots(2,1, figsize=(20,10), sharex=True)
ax1, ax2 = axes
ax1.plot(df_test["close"])
ax2.plot(df_test["mom"], c = 'blue')
ax2.axhline(0, color='black', lw=2)
```




    <matplotlib.lines.Line2D at 0x7f5b1588ae48>




![png](output_58_1.png)


では単純にモメンタムが0以上だったら買い持ち、0以下だったら売り持ちする simulation をしてみましょう。

1. 将来収益率 `df_test["return"]`  を出す
1. `df_test["long position"]` フラグを作る
1. `df_test["short position"]` フラグを作る
1. `df_test["return"]` とフラグを掛け算
1. 足し合わせて積算して描画

売り持ちの時の`df_test["return"]` に注意しましょう。




```python

df_test["return"] = df_test["close"].pct_change().shift(-1)
df_test["long position"] = df_test["mom"] > 0 
df_test["short position"] = df_test["mom"] < 0 

results = df_test["return"] * df_test["long position"] +  df_test["return"] * -1 * df_test["short position"]

fig, axes = plt.subplots(3,1, figsize=(20,10), sharex=True)
ax1, ax2, ax3 = axes
ax1.plot(df_test["close"])
ax2.plot(df_test["mom"], c = 'blue')
ax2.axhline(0, color='black', lw=2)
ax3.plot(results.cumsum())


```




    [<matplotlib.lines.Line2D at 0x7f5b0f477c18>]




![png](output_60_1.png)


### HLバンド

![](https://fx-quicknavi.com/images/chart/hlbands2.png)
 [HLバンドの見方・使い方【テクニカル指標・トレンド系】](https://fx-quicknavi.com/chart/hlbands.html)より

+ H(High)バンド - 過去n日間の高値を結んだ線
+ L(Low)バンド - 過去n日間の安値を結んだ線
+ M(Middle)バンド - HバンドとLバンドの平均線

Hバンド・Lバンドをブレイクしたときに売買シグナルと判断をするみたいで、**Hバンドを上抜けたら買いサイン、Lバンドを下抜けたら売りサイン**、という使い方のようです．

まずは見てみましょう．



```python
df_test = df.copy()

# 過去何日間のバンドを作るか
n = 40
m = 40
df_test["high band"] = df_test["high"].rolling(window=n).max()
df_test["low band"] = df_test["low"].rolling(window=m).min()
df_test["middle band"] = (df_test["low band"] + df_test["high band"]) / 2

fig, axes = plt.subplots(1,1, figsize=(20,10), )
axes.plot(df_test["high band"])
axes.plot(df_test["low band"])
axes.plot(df_test["middle band"])
axes.plot(df_test["close"])
axes.legend()

```




    <matplotlib.legend.Legend at 0x7f5b0f3f6978>




![png](output_62_1.png)


HLバンドを使った戦術もグーグル先生がたくさん教えてくれるのですが，
とりあえず自分たちで観察してみましょう．

**high band が高値を更新している間，ロングポジション**を持っていれば，儲かりそうな気がします．

それでやってみましょう．




```python
# 収益率を出す
df_test["return"] = df_test["close"].pct_change().shift(-1) 

# [高値を更新している間]を[high band 値が昨日の値よりも高い日にフラグを立てる] という戦略に読み替える
df_test["higher than yesterday"] = df_test["high band"] > df_test["high band"].shift(1)

fig, axes = plt.subplots(2,1, figsize=(20,10), )
ax1, ax2 = axes

# 日々の値動き
ax1.plot(df_test["close"])
# high band が前日よりも高い時のフラグを描画
ax2.plot(df_test["higher than yesterday"])

# 収益をsimulation
ax3 = ax2.twinx()
ax3.plot((df_test["higher than yesterday"] * df_test["return"]).cumsum(), c='blue')

```




    [<matplotlib.lines.Line2D at 0x7f5b0f3d8f60>]




![png](output_64_1.png)


### RSI 

RSIはオシレータ系で最も有名な指標かもしれません．計算式も簡単で

\begin{equation*}
RSI = \frac{過去ｎ日間で上昇した値幅}{過去ｎ日間で上昇した値幅+過去ｎ日間で下落した値幅} \times 100　\\
\end{equation*}

使い方は、RSIが一定以下であれば売られすぎ、一定以上なら売られすぎ、という判断をして**逆張り**するようです。

例えば、RSIが30以下の状態は売られすぎ、70以上は買われすぎ、という使い方です。

![](https://www.sevendata.co.jp/melmag/wp-content/uploads/2014/02/20140220.gif)
[【動画解説】５分でわかる！RSIの使い方！ | 株の達人活用ブログ～実践的なテクニックを解説～](https://www.sevendata.co.jp/melmag/archives/1288)より


では、RSIもtalibにありますので，使いましょう．

```
    RSI(real[, timeperiod=?])
    real: 価格配列
    timeperiod: 計算期間。デフォルト14
    
    返り値：RSI配列
```        



```python
df_test = df.copy()
df_test["rsi"] = ta.RSI(df_test["close"].values, timeperiod=21)
df_test.head(30)

```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>close</th>
      <th>open</th>
      <th>high</th>
      <th>low</th>
      <th>rsi</th>
    </tr>
    <tr>
      <th>datetime</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2015-01-05</th>
      <td>17408.71</td>
      <td>17325.68</td>
      <td>17540.92</td>
      <td>17219.22</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-06</th>
      <td>16883.19</td>
      <td>17101.58</td>
      <td>17111.36</td>
      <td>16881.73</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-07</th>
      <td>16885.33</td>
      <td>16808.26</td>
      <td>16974.61</td>
      <td>16808.26</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-08</th>
      <td>17167.10</td>
      <td>17067.40</td>
      <td>17243.71</td>
      <td>17016.09</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-09</th>
      <td>17197.73</td>
      <td>17318.74</td>
      <td>17342.65</td>
      <td>17129.53</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-13</th>
      <td>17087.71</td>
      <td>16970.88</td>
      <td>17087.71</td>
      <td>16828.27</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-14</th>
      <td>16795.96</td>
      <td>16961.82</td>
      <td>17036.72</td>
      <td>16770.56</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-15</th>
      <td>17108.70</td>
      <td>16872.95</td>
      <td>17141.98</td>
      <td>16856.22</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-16</th>
      <td>16864.16</td>
      <td>16812.96</td>
      <td>16864.34</td>
      <td>16592.57</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-19</th>
      <td>17014.29</td>
      <td>17000.78</td>
      <td>17039.80</td>
      <td>16911.58</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-20</th>
      <td>17366.30</td>
      <td>17071.65</td>
      <td>17366.30</td>
      <td>17066.77</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-21</th>
      <td>17280.48</td>
      <td>17308.72</td>
      <td>17329.03</td>
      <td>17181.55</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-22</th>
      <td>17329.02</td>
      <td>17306.64</td>
      <td>17355.74</td>
      <td>17229.21</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-23</th>
      <td>17511.75</td>
      <td>17520.63</td>
      <td>17532.06</td>
      <td>17460.76</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-26</th>
      <td>17468.52</td>
      <td>17285.71</td>
      <td>17471.94</td>
      <td>17285.71</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-27</th>
      <td>17768.30</td>
      <td>17649.40</td>
      <td>17768.41</td>
      <td>17633.47</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-28</th>
      <td>17795.73</td>
      <td>17615.93</td>
      <td>17850.59</td>
      <td>17615.93</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-29</th>
      <td>17606.22</td>
      <td>17666.91</td>
      <td>17778.83</td>
      <td>17575.10</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-01-30</th>
      <td>17674.39</td>
      <td>17788.74</td>
      <td>17808.47</td>
      <td>17661.10</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-02</th>
      <td>17558.04</td>
      <td>17536.61</td>
      <td>17628.40</td>
      <td>17459.45</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-03</th>
      <td>17335.85</td>
      <td>17654.60</td>
      <td>17654.60</td>
      <td>17271.87</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2015-02-04</th>
      <td>17678.74</td>
      <td>17549.30</td>
      <td>17743.11</td>
      <td>17535.04</td>
      <td>53.437342</td>
    </tr>
    <tr>
      <th>2015-02-05</th>
      <td>17504.62</td>
      <td>17589.21</td>
      <td>17619.34</td>
      <td>17484.67</td>
      <td>51.060691</td>
    </tr>
    <tr>
      <th>2015-02-06</th>
      <td>17648.50</td>
      <td>17696.18</td>
      <td>17700.67</td>
      <td>17603.07</td>
      <td>52.879034</td>
    </tr>
    <tr>
      <th>2015-02-09</th>
      <td>17711.93</td>
      <td>17790.31</td>
      <td>17799.49</td>
      <td>17653.61</td>
      <td>53.675761</td>
    </tr>
    <tr>
      <th>2015-02-10</th>
      <td>17652.68</td>
      <td>17662.67</td>
      <td>17673.27</td>
      <td>17550.03</td>
      <td>52.800145</td>
    </tr>
    <tr>
      <th>2015-02-12</th>
      <td>17979.72</td>
      <td>17899.40</td>
      <td>18005.45</td>
      <td>17884.34</td>
      <td>56.877180</td>
    </tr>
    <tr>
      <th>2015-02-13</th>
      <td>17913.36</td>
      <td>17892.10</td>
      <td>17962.11</td>
      <td>17864.55</td>
      <td>55.849361</td>
    </tr>
    <tr>
      <th>2015-02-16</th>
      <td>18004.77</td>
      <td>18024.01</td>
      <td>18074.26</td>
      <td>17978.90</td>
      <td>56.973932</td>
    </tr>
    <tr>
      <th>2015-02-17</th>
      <td>17987.09</td>
      <td>17949.70</td>
      <td>18009.45</td>
      <td>17901.26</td>
      <td>56.680733</td>
    </tr>
  </tbody>
</table>
</div>




```python
fig, axes = plt.subplots(2,1,figsize=(20,10), sharex=True)
ax1, ax2 = axes 

ax1.plot(df_test["close"])
ax2.plot(df_test["rsi"], c="blue")
ax2.axhline(30, color='black', lw=2)
ax2.axhline(80, color='black', lw=2)

```




    <matplotlib.lines.Line2D at 0x7f5b0ee68668>




![png](output_67_1.png)


では観察してみましょう。現在、RSIを期間21日で計算して、30を売られすぎ、70を買われすぎさ水準とみなして描画したのですが、どうでしょう？
期間や水準を変えて、多少納得の行く感じにしてみましょう。

こういう時、パラメータを変えて一つずつ見ていくのは面倒です。一度に結果を描画して比べたいですよね。

複数のグラフを描画する方法はいくつかありますが、シンプルな方法を一つご紹介します。



```python
x = 3 # 縦の枚数
y = 4 # 横の枚数
a = 0 # 必須ではないが、何枚目かを確認するためのパラメタ

fig, axes = plt.subplots(x,y,figsize=(20,10), sharex=True)

# for を入れ子にしたくない人はリスト内包記を使うといいです。
for i in range(x):
    for t in range(y):
        text = "{},{},ax{}".format(i,t,a)
        axes[i,t].text(0.1, 0.6, text, size=40)
        a += 1

```


![png](output_69_0.png)



```python
rsi_list = [(80,20), (70,30), (90,10)]
periods = [14,21,30,]
x = len(rsi_list)
y = len(periods)

fig, axes = plt.subplots(x,y,figsize=(20,10), sharex=True)

# for を入れ子にしたくない人はリスト内包記を使うといいです。

for i,rsi in enumerate(rsi_list):
    for t, period in enumerate(periods):
        upper, lower = rsi

        title = "{},{},{}".format(upper, lower, period)
        df_test["rsi"] = ta.RSI(df_test["close"].values, timeperiod=period)
        
        axes[i,t].plot(df_test["close"])
        axes[i,t].set_title(title)
        ax1 = axes[i,t].twinx()
        ax1.plot(df_test["rsi"], c = 'blue', )
        ax1.axhline(upper, color='black', lw=2)
        ax1.axhline(lower, color='black', lw=2)
        
```


![png](output_70_0.png)


うん、どれも良さそうに見えないですね。。。パラメータを変えて良さそうなのが見つかったら教えてください。複数プロット表示をしたので良しとして次言ってみましょうｗ


## MACD

MACDは，期間の長い指数移動平均と短い指数移動平均の差を使って売買シグナルを出す指標です．

移動平均はすでに説明しましたが、今回使うのは**指数**移動平均。移動平均に指数関数的に重み付けした移動平均です。説明は難しいので詳しくは[wikipedia](https://ja.wikipedia.org/wiki/%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87#%E6%8C%87%E6%95%B0%E7%A7%BB%E5%8B%95%E5%B9%B3%E5%9D%87)先生にお尋ねください。


MACDを株式分析に使う時はこのような計算をして、

```
MACD = SlowEMA - FastEMA
MACDSignal = SMA(MACD) 

ただし
　SlowEMA : 期間の長い指数移動平均
　FastEMA : 期間の短い指数移動平均
　SMA：移動平均関数
```

`MACD`が`MACDSignal`を上抜いた時，ロングポジションを取るようです。下図を例に説明するとゴールデンクロスと呼ばれるところで買い持ちし、デッドクロスで売り持ちするようです。

![](https://www.nomura.co.jp/learn/chart/images/chart_08_img04_2.gif)
[野村證券 | 株・FXに今すぐ活かせる チャートの読み方・使い方 - トレンドフォロー系指標「移動平均」と「MACD」 -](https://www.nomura.co.jp/learn/chart/page8.html)より

まずは、`MACD`と`MACDSignal`を描画してみましょう。MACD もtalibに定義されています。


```
MACD(real[, fastperiod=?, slowperiod=?, signalperiod=?])
    
    Inputs:
        real: 関数配列
    Parameters:
        fastperiod: 短い指数移動平均の期間　デフォルト 12　
        slowperiod: 長い指数移動平均の期間　デフォルト 26　
        signalperiod: 移動平均の期間　デフォルト 9　
    Outputs:　
        macd
        macdsignal
        macdhist
```



```python
df_test = df.copy()

macd, macdsignal, macdhist = ta.MACD(df_test["cdf_nissanlose"].values) # 期間のパラメータはデフォルト値を使う
df_test["macd"] = macd
df_test["macdsignal"] = macdsignal
```


```python
fig, axes = plt.subplots(2,1, figsize=(20,10), sharex=True)
ax1, ax2 = axes 
ax1.plot(df_test["close"])
ax2.plot(df_test["macd"] )
ax3 = ax2.twinx()
ax3.plot(df_test["macdsignal"], c='blue')

```




    [<matplotlib.lines.Line2D at 0x7f5b0dfbe748>]




![png](output_73_1.png)


観察してみましょう。

こうやって見てみると、単に`macd`が`macdsignal`をうわ抜いた時というより、上にある間は上昇トレンド、下にある間は下降トレンドのように見えます。どうでしょう？

その発想で simulation を書いてみましょう。

わかりやすくするためにこのような条件にしてみます。

「`macd`が`macdsignal`を5日以上上回っていたら買い持ちし続ける。」

としてみましょう。

simulation を書くためには、

1. `macd`が`macdsignal`より上にあるかどうかのフラグ `df_test["flag"]` を作成
1. `df_test["flag"]` の移動足し算を `df_test["moving sum"]` を作成
1. `df_test["moving sum"]`が5であれば過去5日間すべて `macd`が`macdsignal`より上にあることになるので、`df_test["moving sum"]`が5であるかどうかのフラグ `df_test["long"]` を作成
1. あとはいつも通り、将来収益率を`df_test["long"]`に掛け算してプロットする。

やってみよう！

答えは下のセルに隠してあります。




```python

# df_test["flag"] = df_test["macd"] > df_test["macdsignal"] 
# df_test["moving sum"] = df_test["flag"].rolling(window=5).sum() 
# df_test["long"] = df_test["moving sum"] == 5
# df_test["return"] = df_test["close"].pct_change().shift(-1)

# fig, axes = plt.subplots(1,1,figsize=(20,10))
# axes.plot((df_test["return"] * df_test["long"]).cumsum())

```



<script>
let cells = $(".cell");
for(let i=0;i<cells.length;i++){    
    if( $(cells[i]).text().includes("#green") ){
        $(cells[i]).find(".CodeMirror").css("background-color","#408080");
    }
    else{
        $(cells[i]).find(".CodeMirror").css("background-color","#f7f7f7");
    }
}
</script>



## 練習問題

（**答えは別ノートブック [テクニカル分析練習問題答え]にまとめています。**）

1. https://kabuoji3.com/stock/ から好きな会社の株価を4つダウンロードしてください。（2018年だけでいいです）
1. csv を dataframe にしてください。その時DateTime型や数値型になっている事をキチンと確認してください。
1. 各銘柄の[終値調整値]をプロットしてください。
1. 各銘柄の[終値調整値]の移動平均をプロットしてください。
1. お好きな分析指標を使ってsimulation をしてください。ただしHLバンドをする場合は、高値と安値は、終値調整値で調整してください。



### 終値調整値とは、

日付|始値|高値|安値|終値|出来高|終値調整値
---|---:|---:|---:|---:|---:|---:
2009-01-05|37150|37450|36550|37000|48382|370
2009-01-06|37300|40300|37200|38400|222607|384
2009-01-07|38400|39900|35100|36050|225114|360.5
2009-01-08|36200|36300|33500|33950|203189|339.5
2009-01-09|34750|34850|33900|34100|132310|341
2009-01-13|34050|34050|33050|33450|70888|334.5

これやヤフーの2009年の株価です。ヤフーは2009年以降何度か株式分割ををしています。その分割を調整して、現在の価格と比較出来るようにしたのが「終値調整値」です。

通常、終値調整値は終値でしか示されていない事が多いです。ですので、始値、高値、安値を検証する場合は、終値調整値から計算して調整する必要があります。

計算方法は、`終値調整値 / 終値` で係数を作り、それを各値に掛ければよいです。例：

日付|始値|高値|安値|終値|出来高|終値調整値|係数|調整後始値|調整後高値|調整後安値
---|---:|---:|---:|---:|---:|---:|---:|---:|---:|---:
2009-01-05|37150|37450|36550|37000|48382|370|0.01|371.5|374.5|365.5
2009-01-06|37300|40300|37200|38400|222607|384|0.01|373|403|372
2009-01-07|38400|39900|35100|36050|225114|360.5|0.01|384|399|351
2009-01-08|36200|36300|33500|33950|203189|339.5|0.01|362|363|335
2009-01-09|34750|34850|33900|34100|132310|341|0.01|347.5|348.5|339
2009-01-13|34050|34050|33050|33450|70888|334.5|0.01|340.5|340.5|330.5




参照：
[Yahoo!ファイナンスヘルプ - 調整後終値とは](https://www.yahoo-help.jp/app/answers/detail/p/546/a_id/45316/~/%E8%AA%BF%E6%95%B4%E5%BE%8C%E7%B5%82%E5%80%A4%E3%81%A8%E3%81%AF)

